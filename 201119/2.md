## 어노테이션 기반으로 개선하기

#### 해야할 일
1. 어노테이션 클래스 만들기   


```
@Target(ElementType.PARAMETER) // 어노테이션이 생성될 수 있는 위치 지정: 메소드 파라미터 객체에 생성
@Retention(RetentionPolicy.RUNTIME) // 어느 시점까지 어노테이션의 메모리를 가지고 갈 수 있는지 지정: 런타임에도 어노테이션 사용 가능하게
public @interface LoginUser { // @interface로 어노테이션 클래스 지정
}
```
  
2. LoginUserArgumentResolver 클래스 만들기  
- HandlerMethodArgumentResolver 인터페이스를 구현  
- 파라미터 조건에 맞는 경우의 메소드가 있다면 인터페이스의 구현체가 지정한 값으로 파라미터를 넘길 수 있다.  
- 조건: **supportsParameter 메소드**를 오버라이드해서 파라미터에 앞서 생성한 LoginUser 어노테이션을 붙였는지 확인한다.
- 조건에 맞는 경우: **resolveArgument 메소드**를 오버라이드해서 조건에 맞는 경우 넘길 파라미터를 지정한다.  

=> 예제의 경우 조건을 LoiginUser어노테이션을 붙였는지 확인하고, 맞을 경우 세션 객체를 반환한다.

3. 코드 개선하기  
=> 예제에서는 중복되는 세션 확인 부분을 어노테이션을 사용해 개선.   
=> SessionUser 파라미터 앞에 어노테이션을 붙인다.
  
## 세션 저장소로 데이터베이스 사용하기   
### 세션 저장소란?
세션은 실행되는 WAS에 저장되고 호출된다. 그래서 WAS가 실행될 때마다 초기화된다.  

| Tomcat 세션 | 데이터베이스 | 메모리 DB |
| ----- | ----- | ----- |
| 세션 공유를 위한 추가 설정 필요 | 여러 WAS 간 공유 가능 | 외부 메모리 서버 사용 |
| 배포시 초기화 | DB IO 발생 | 모든 데이터를 메모리에 저장해 속도 빠름 |

> + Redis란?   
> 메모리에 NoSQL 데이터를 관리하는 DBMS이다.
> 데이터가 메모리와 디스크에 저장되지만 메모리 재사용이 없어 속도가 빠르다.
> 데이터에 만료일을 지정할 수 있어 만료되면 데이터는 영구적으로 사라진다.

## 네이버 로그인  
[네이버 오픈 API](https://developers.naver.com/products/login/api/)에서 애플리케이션을 등록하고 API key값을 받을 수 있다.  
* 네이버에서는 스프링 시큐리티를 공식 지원하지 않음.
* 수동으로 properties에 값들을 입력해주어야 함.

## 참고하면 좋은 것들

### HTTP 302 에러  
: 리다이렉션 응답으로 스프링 시큐리티는 인증되지 않은 사용자의 요청을 이동시킨다.

### @WithMockUser 어노테이션  
: 임의의 사용자 인증을 추가하는 어노테이션이다.  
-> MockMvc에서만 작동한다.

### @WebMvcTest 어노테이션  
- @WebMvcTest은 Controller layer를 테스트하고 모의 객체를 사용하기 때문에 나머지 필요한 bean을 직접 세팅해줘야 한다.  
- 웹 어댑터, 설정, @Controller와 관련된 어노테이션이 붙은 것만 읽는다.
- 통합 테스트를 제공한다.
- Mock 기반이라서 실제 환경에서는 동작하지 않을 수도 있다.
